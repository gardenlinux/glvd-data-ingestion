#!/usr/bin/python3

# Based on [nalanj/migrations](https://github.com/nalanj/migrations), Copyright nalanj under the MIT License

import os
import sys
import glob
import re
import psycopg2

DEFAULT_MIGRATIONS_DIR = "/usr/local/src/schema/"

def get_migration_id(filename):
    match = re.match(r"(\d{3})", os.path.basename(filename))
    return int(match.group(1)) if match else None

def main(migrations_dir=DEFAULT_MIGRATIONS_DIR):
    database_url = os.environ.get("DATABASE_URL")
    if not database_url:
        print("DATABASE_URL must be set")
        sys.exit(1)
    if not migrations_dir or not os.path.isdir(migrations_dir):
        print(f"Usage: migrate-all [dir]\nDefault migrations dir: {DEFAULT_MIGRATIONS_DIR}")
        sys.exit(1)

    sql_files = sorted(
        glob.glob(os.path.join(migrations_dir, "*.sql")),
        key=lambda f: get_migration_id(f)
    )
    if not sql_files:
        print("No .sql files found in", migrations_dir)
        sys.exit(1)

    conn = psycopg2.connect(database_url)
    try:
        with conn:
            with conn.cursor() as cur:
                latest_id = -1
                try:
                    cur.execute("SELECT COALESCE(MAX(id), -1) FROM migrations;")
                    latest_id = cur.fetchone()[0]
                except psycopg2.errors.UndefinedTable:
                    print("Migrations table does not yet exist, starting from scratch")

                print(f"Latest applied migration id: {latest_id}")

                for file in sql_files:
                    migration_id = get_migration_id(file)
                    if migration_id is None:
                        print(f"Skipping file with invalid name: {file}")
                        continue
                    if migration_id <= latest_id:
                        print(f"Skipping already applied migration: {file}")
                        continue
                    print(f"Applying migration: {file}")
                    with open(file, "r") as f:
                        sql_code = f.read()
                        cur.execute(sql_code)
                    print(f"Migration {migration_id} applied.")
        print("All pending migrations applied successfully.")
    except Exception as e:
        print(f"Migration failed: {e}")
        sys.exit(1)
    finally:
        conn.close()

if __name__ == "__main__":
    migrations_dir = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_MIGRATIONS_DIR
    main(migrations_dir)
